schema: '2.0'
stages:
  prepare_data:
    cmd: PYTHONPATH=src python -m air_quality_imputer.pipeline.prepare_data 
      --params configs/pipeline/params.yaml
    deps:
    - path: configs/pipeline/params.yaml
      hash: md5
      md5: 5c5cbec2a0d60961af2280a58941af59
      size: 3385
    - path: data/datasets
      hash: md5
      md5: 394670e7e653db66ca30b6313376f4c2.dir
      size: 62114935
      nfiles: 16
    - path: data/raw
      hash: md5
      md5: 2e63b05f91bd8adf716e3332c0d18150.dir
      size: 39174879
      nfiles: 22
    - path: src/air_quality_imputer/data/electricity_dataset.py
      hash: md5
      md5: 3aa9a3235e40ccd3ed42a43dd2c1849f
      size: 10715
    - path: src/air_quality_imputer/pipeline/common.py
      hash: md5
      md5: 98a131c183257fdce4f99b64b7c4560d
      size: 1962
    - path: src/air_quality_imputer/pipeline/dataset_adapters.py
      hash: md5
      md5: 1c4408acba720870aebe78673744a82f
      size: 16134
    - path: src/air_quality_imputer/pipeline/prepare_data.py
      hash: md5
      md5: 96e9a2e284db4ad6c6ef5fb72b8600f0
      size: 3380
    - path: src/air_quality_imputer/training/data_utils.py
      hash: md5
      md5: ad9ba7255b4f83af48e497793e9cf8b1
      size: 12019
    params:
      configs/pipeline/params.yaml:
        dataset:
          definitions:
            air_quality:
              loader: air_quality_csv
              data_dir: data/raw
              feature_names:
              - PM10
              - PM2.5
              - temperature
              - rain
              - pressure
              - precipitation
              - wind_speed
              - clouds
              - wind_direction
            beijing_air_quality:
              loader: air_quality_csv
              data_dir: data/datasets/beijing_air_quality/materialized
              feature_names:
              - PM2.5
              - PM10
              - SO2
              - NO2
              - CO
              - O3
              - TEMP
              - PRES
              - DEWP
              - RAIN
              - WSPM
            electricity:
              loader: npz
              npz_path: data/datasets/electricity/npz/electricity.npz
              data_dir: data/datasets/electricity/materialized
              value_key: X
              datetime_key: datetime
              feature_names_key: feature_names
              ensure:
                kind: electricity_uci
                cache_dir: data/datasets/electricity/cache
                start_client: 1
                n_clients: 16
                resample_frequency: 1h
        experiment:
          dataset: beijing_air_quality
          stations:
          - combined
          models:
          - transformer
          - saits
          features: []
          never_mask_features: []
          block_size: 24
          step_size: 1
          seed: 42
        paths.data_dir: data/raw
        paths.processed_dir: data/processed/splits
        training.shared_validation_mask:
          missing_rate: 0.2
          mask_mode: random
          block_min_len: 2
          block_max_len: 14
          block_missing_prob: 0.35
          feature_block_prob: 0.6
          block_no_overlap: true
    outs:
    - path: data/processed/splits
      hash: md5
      md5: 609e7a7f90efa81865440234206b277a.dir
      size: 24206076
      nfiles: 2
  train_models:
    cmd: PYTHONPATH=src python -m air_quality_imputer.pipeline.train_models 
      --params configs/pipeline/params.yaml
    deps:
    - path: configs/pipeline/params.yaml
      hash: md5
      md5: 5c5cbec2a0d60961af2280a58941af59
      size: 3385
    - path: data/processed/splits
      hash: md5
      md5: 609e7a7f90efa81865440234206b277a.dir
      size: 24206076
      nfiles: 2
    - path: src/air_quality_imputer/models
      hash: md5
      md5: 75c35388b15df3f355a914e48ec55df5.dir
      size: 30172
      nfiles: 4
    - path: src/air_quality_imputer/pipeline/common.py
      hash: md5
      md5: 98a131c183257fdce4f99b64b7c4560d
      size: 1962
    - path: src/air_quality_imputer/pipeline/train_models.py
      hash: md5
      md5: 26cc6e8e3178a70f6f3c32ed01f6e351
      size: 10971
    - path: src/air_quality_imputer/tracking/mlflow_utils.py
      hash: md5
      md5: 6cad2ec11420475b6b025955d10161f4
      size: 4863
    - path: src/air_quality_imputer/training/model_registry.py
      hash: md5
      md5: 7704f2c9969392d59ec578ca1c3b17d1
      size: 2688
    params:
      configs/pipeline/params.yaml:
        experiment.models:
        - transformer
        - saits
        experiment.seed: 42
        models:
          transformer:
            type: classic_transformer
            checkpoint_name: transformer.pt
            params:
              d_model: 128
              n_layer: 4
              n_head: 4
              dropout: 0.1
              bias: true
              norm_eps: 1e-06
              use_torch_compile: true
              compile_mode: reduce-overhead
              compile_dynamic: false
              optimizer_fused: true
              optimizer_weight_decay: 0.01
              scheduler_warmup_ratio: 0.125
              scheduler_warmup_start_factor: 0.3
              scheduler_min_lr: 1e-07
              grad_clip_norm: 0.5
              dataloader_num_workers: -1
              dataloader_prefetch_factor: 4
              dataloader_persistent_workers: true
              dataloader_pin_memory: true
          saits:
            type: saits
            checkpoint_name: saits.pt
            params:
              d_model: 128
              n_layers: 4
              n_head: 4
              dropout: 0.1
              attn_dropout: 0.1
              diagonal_attention_mask: true
              d_ffn: 512
              ORT_weight: 1.0
              MIT_weight: 1.0
              training_loss: MAE
              validation_metric: MAE
              num_workers: 0
              saving_path:
              model_saving_strategy: best
              verbose: true
              optimizer: adam
              optimizer_weight_decay: 0.01
              optimizer_betas:
              - 0.9
              - 0.999
              optimizer_eps: 1e-08
              learning_rate:
        paths.models_dir: artifacts/models
        tracking:
          enabled: true
          repo_owner: PetelinekBenjamin
          repo_name: air-quality-missing-data-imputation
        training:
          epochs: 100
          batch_size: 256
          lr: 0.001
          patience: 20
          min_delta: 0.0001
          train_mask:
            transformer:
              mode: random
              missing_rate: 0.2
              block_min_len: 2
              block_max_len: 14
              block_missing_prob: 0.35
              feature_block_prob: 0.6
              block_no_overlap: true
            saits:
              mode: random
              missing_rate: 0.2
          shared_validation_mask:
            missing_rate: 0.2
            mask_mode: random
            block_min_len: 2
            block_max_len: 14
            block_missing_prob: 0.35
            feature_block_prob: 0.6
            block_no_overlap: true
    outs:
    - path: artifacts/models
      hash: md5
      md5: 748ed8c037a7fd4f61f97f8e20669815.dir
      size: 34937843
      nfiles: 2
  evaluate_models:
    cmd: PYTHONPATH=src python -m air_quality_imputer.pipeline.evaluate_models 
      --params configs/pipeline/params.yaml
    deps:
    - path: artifacts/models
      hash: md5
      md5: 748ed8c037a7fd4f61f97f8e20669815.dir
      size: 34937843
      nfiles: 2
    - path: configs/pipeline/params.yaml
      hash: md5
      md5: 5c5cbec2a0d60961af2280a58941af59
      size: 3385
    - path: data/processed/splits
      hash: md5
      md5: 609e7a7f90efa81865440234206b277a.dir
      size: 24206076
      nfiles: 2
    - path: src/air_quality_imputer/models
      hash: md5
      md5: 75c35388b15df3f355a914e48ec55df5.dir
      size: 30172
      nfiles: 4
    - path: src/air_quality_imputer/pipeline/common.py
      hash: md5
      md5: 98a131c183257fdce4f99b64b7c4560d
      size: 1962
    - path: src/air_quality_imputer/pipeline/evaluate_models.py
      hash: md5
      md5: 13b34e1a6fc465bc229a49a6bfeb8473
      size: 14451
    - path: src/air_quality_imputer/tracking/mlflow_utils.py
      hash: md5
      md5: 6cad2ec11420475b6b025955d10161f4
      size: 4863
    - path: src/air_quality_imputer/training/data_utils.py
      hash: md5
      md5: ad9ba7255b4f83af48e497793e9cf8b1
      size: 12019
    - path: src/air_quality_imputer/training/model_registry.py
      hash: md5
      md5: 7704f2c9969392d59ec578ca1c3b17d1
      size: 2688
    params:
      configs/pipeline/params.yaml:
        evaluation:
          missing_rate: 0.2
          mask_mode: random
          block_min_len: 2
          block_max_len: 14
          block_missing_prob: 0.35
          feature_block_prob: 0.6
          block_no_overlap: true
          mlflow_model_refs:
            transformer:
            saits:
        experiment:
          dataset: beijing_air_quality
          stations:
          - combined
          models:
          - transformer
          - saits
          features: []
          never_mask_features: []
          block_size: 24
          step_size: 1
          seed: 42
        models:
          transformer:
            type: classic_transformer
            checkpoint_name: transformer.pt
            params:
              d_model: 128
              n_layer: 4
              n_head: 4
              dropout: 0.1
              bias: true
              norm_eps: 1e-06
              use_torch_compile: true
              compile_mode: reduce-overhead
              compile_dynamic: false
              optimizer_fused: true
              optimizer_weight_decay: 0.01
              scheduler_warmup_ratio: 0.125
              scheduler_warmup_start_factor: 0.3
              scheduler_min_lr: 1e-07
              grad_clip_norm: 0.5
              dataloader_num_workers: -1
              dataloader_prefetch_factor: 4
              dataloader_persistent_workers: true
              dataloader_pin_memory: true
          saits:
            type: saits
            checkpoint_name: saits.pt
            params:
              d_model: 128
              n_layers: 4
              n_head: 4
              dropout: 0.1
              attn_dropout: 0.1
              diagonal_attention_mask: true
              d_ffn: 512
              ORT_weight: 1.0
              MIT_weight: 1.0
              training_loss: MAE
              validation_metric: MAE
              num_workers: 0
              saving_path:
              model_saving_strategy: best
              verbose: true
              optimizer: adam
              optimizer_weight_decay: 0.01
              optimizer_betas:
              - 0.9
              - 0.999
              optimizer_eps: 1e-08
              learning_rate:
        paths.metrics_dir: reports/metrics
        paths.reports_dir: reports/model_eval
        tracking:
          enabled: true
          repo_owner: PetelinekBenjamin
          repo_name: air-quality-missing-data-imputation
    outs:
    - path: reports/metrics/model_eval_metrics.json
      hash: md5
      md5: 29377807e8d6ac94774ba1b34f261afe
      size: 408
    - path: reports/model_eval
      hash: md5
      md5: 5bc4f241f30ae020498a9d06a7c72fed.dir
      size: 322
      nfiles: 3
