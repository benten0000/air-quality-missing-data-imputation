schema: '2.0'
stages:
  prepare_data:
    cmd: PYTHONPATH=src python -m air_quality_imputer.pipeline.prepare_data 
      --params configs/pipeline/params.yaml
    deps:
    - path: configs/pipeline/params.yaml
      hash: md5
      md5: a9d5b0e4256b5f2e0e41be80e401ebcb
      size: 2450
    - path: data/raw
      hash: md5
      md5: 2e63b05f91bd8adf716e3332c0d18150.dir
      size: 39174879
      nfiles: 22
    - path: src/air_quality_imputer/pipeline/common.py
      hash: md5
      md5: e871b431d547437f5fd847772b1521f0
      size: 2206
    - path: src/air_quality_imputer/pipeline/prepare_data.py
      hash: md5
      md5: 3fd3aedbb814801b20d4aa728f6bf2a3
      size: 3307
    - path: src/air_quality_imputer/training/data_utils.py
      hash: md5
      md5: 9ca1379dcb7d9a1d4a524e7eb94fe72a
      size: 14620
    params:
      configs/pipeline/params.yaml:
        experiment:
          stations:
          - all_stations
          models:
          - transformer
          - saits
          features:
          - station
          - PM10
          - PM2.5
          - temperature
          - rain
          - pressure
          - precipitation
          - wind_speed
          - clouds
          - wind_direction
          never_mask_features:
          - station
          block_size: 24
          step_size: 1
          missing_rate: 0.2
          seed: 42
          mask_mode: random
          block_min_len: 2
          block_max_len: 14
          block_missing_prob: 0.35
          feature_block_prob: 0.6
          block_no_overlap: true
        paths.data_dir: data/raw
        paths.processed_dir: data/processed/splits
        paths.scalers_dir: data/processed/scalers
    outs:
    - path: data/processed/scalers
      hash: md5
      md5: e5b6ace05440a4559bcdf5bffe49d04d.dir
      size: 783
      nfiles: 1
    - path: data/processed/splits
      hash: md5
      md5: 0c2f67567faf8ea78b78828ab6457a20.dir
      size: 28484460
      nfiles: 5
  train_models:
    cmd: PYTHONPATH=src python -m air_quality_imputer.pipeline.train_models 
      --params configs/pipeline/params.yaml
    deps:
    - path: configs/pipeline/params.yaml
      hash: md5
      md5: a9d5b0e4256b5f2e0e41be80e401ebcb
      size: 2450
    - path: data/processed/scalers
      hash: md5
      md5: e5b6ace05440a4559bcdf5bffe49d04d.dir
      size: 783
      nfiles: 1
    - path: data/processed/splits
      hash: md5
      md5: 0c2f67567faf8ea78b78828ab6457a20.dir
      size: 28484460
      nfiles: 5
    - path: src/air_quality_imputer/models
      hash: md5
      md5: 586232ceb3b01c2f291417467fae6e92.dir
      size: 30011
      nfiles: 4
    - path: src/air_quality_imputer/pipeline/common.py
      hash: md5
      md5: e871b431d547437f5fd847772b1521f0
      size: 2206
    - path: src/air_quality_imputer/pipeline/train_models.py
      hash: md5
      md5: d686ec7ee69012e1dfaef1b05818e0af
      size: 5969
    - path: src/air_quality_imputer/tracking/mlflow_utils.py
      hash: md5
      md5: 74d2691914edd63b52b71fff6140056e
      size: 5796
    - path: src/air_quality_imputer/training/model_registry.py
      hash: md5
      md5: a7907802ba9659c5dd3add24b76b82f4
      size: 3110
    params:
      configs/pipeline/params.yaml:
        experiment.models:
        - transformer
        - saits
        experiment.seed: 42
        models:
          transformer:
            type: classic_transformer
            checkpoint_name: transformer.pt
            params:
              d_model: 128
              n_layer: 3
              n_head: 4
              dropout: 0.1
              bias: true
              norm_eps: 1e-06
              use_torch_compile: true
              compile_mode: reduce-overhead
              compile_dynamic: false
              optimizer_fused: true
              optimizer_weight_decay: 0.01
              scheduler_warmup_ratio: 0.125
              scheduler_warmup_start_factor: 0.3
              scheduler_min_lr: 1e-07
              grad_clip_norm: 0.5
              dataloader_num_workers: -1
              dataloader_prefetch_factor: 4
              dataloader_persistent_workers: true
              dataloader_pin_memory: true
              train_mask_mode: random
              train_missing_rate: 0.2
              train_block_min_len: 2
              train_block_max_len: 14
              train_block_missing_prob: 0.35
              train_feature_block_prob: 0.6
              train_block_no_overlap: true
          saits:
            type: saits
            checkpoint_name: saits.pt
            params:
              d_model: 128
              n_layers: 3
              n_head: 4
              dropout: 0.1
              attn_dropout: 0.1
              diagonal_attention_mask: true
              d_ffn: 512
              ORT_weight: 1.0
              MIT_weight: 1.0
              training_loss: MAE
              validation_metric: MSE
              num_workers: 0
              saving_path:
              model_saving_strategy: best
              verbose: true
              optimizer: adam
              optimizer_weight_decay: 0.01
              optimizer_betas:
              - 0.9
              - 0.999
              optimizer_eps: 1e-08
              learning_rate:
        paths.models_dir: artifacts/models
        tracking:
          enabled: true
          repo_owner: PetelinekBenjamin
          repo_name: air-quality-missing-data-imputation
          experiment_name: air-quality-imputer
        training:
          epochs: 120
          batch_size: 128
          lr: 0.0008
          patience: 20
          min_delta: 0.0001
    outs:
    - path: artifacts/models
      hash: md5
      md5: 26ccc85c7acc9d410252c99b8cc96fd1.dir
      size: 24552516
      nfiles: 2
  evaluate_models:
    cmd: PYTHONPATH=src python -m air_quality_imputer.pipeline.evaluate_models 
      --params configs/pipeline/params.yaml
    deps:
    - path: artifacts/models
      hash: md5
      md5: 26ccc85c7acc9d410252c99b8cc96fd1.dir
      size: 24552516
      nfiles: 2
    - path: configs/pipeline/params.yaml
      hash: md5
      md5: a9d5b0e4256b5f2e0e41be80e401ebcb
      size: 2450
    - path: data/processed/splits
      hash: md5
      md5: 0c2f67567faf8ea78b78828ab6457a20.dir
      size: 28484460
      nfiles: 5
    - path: src/air_quality_imputer/models
      hash: md5
      md5: 586232ceb3b01c2f291417467fae6e92.dir
      size: 30011
      nfiles: 4
    - path: src/air_quality_imputer/pipeline/common.py
      hash: md5
      md5: e871b431d547437f5fd847772b1521f0
      size: 2206
    - path: src/air_quality_imputer/pipeline/evaluate_models.py
      hash: md5
      md5: feb468d1bba78c00ad5d5afb9b9c0c68
      size: 17946
    - path: src/air_quality_imputer/tracking/mlflow_utils.py
      hash: md5
      md5: 74d2691914edd63b52b71fff6140056e
      size: 5796
    - path: src/air_quality_imputer/training/data_utils.py
      hash: md5
      md5: 9ca1379dcb7d9a1d4a524e7eb94fe72a
      size: 14620
    - path: src/air_quality_imputer/training/model_registry.py
      hash: md5
      md5: a7907802ba9659c5dd3add24b76b82f4
      size: 3110
    params:
      configs/pipeline/params.yaml:
        experiment:
          stations:
          - all_stations
          models:
          - transformer
          - saits
          features:
          - station
          - PM10
          - PM2.5
          - temperature
          - rain
          - pressure
          - precipitation
          - wind_speed
          - clouds
          - wind_direction
          never_mask_features:
          - station
          block_size: 24
          step_size: 1
          missing_rate: 0.2
          seed: 42
          mask_mode: random
          block_min_len: 2
          block_max_len: 14
          block_missing_prob: 0.35
          feature_block_prob: 0.6
          block_no_overlap: true
        models:
          transformer:
            type: classic_transformer
            checkpoint_name: transformer.pt
            params:
              d_model: 128
              n_layer: 3
              n_head: 4
              dropout: 0.1
              bias: true
              norm_eps: 1e-06
              use_torch_compile: true
              compile_mode: reduce-overhead
              compile_dynamic: false
              optimizer_fused: true
              optimizer_weight_decay: 0.01
              scheduler_warmup_ratio: 0.125
              scheduler_warmup_start_factor: 0.3
              scheduler_min_lr: 1e-07
              grad_clip_norm: 0.5
              dataloader_num_workers: -1
              dataloader_prefetch_factor: 4
              dataloader_persistent_workers: true
              dataloader_pin_memory: true
              train_mask_mode: random
              train_missing_rate: 0.2
              train_block_min_len: 2
              train_block_max_len: 14
              train_block_missing_prob: 0.35
              train_feature_block_prob: 0.6
              train_block_no_overlap: true
          saits:
            type: saits
            checkpoint_name: saits.pt
            params:
              d_model: 128
              n_layers: 3
              n_head: 4
              dropout: 0.1
              attn_dropout: 0.1
              diagonal_attention_mask: true
              d_ffn: 512
              ORT_weight: 1.0
              MIT_weight: 1.0
              training_loss: MAE
              validation_metric: MSE
              num_workers: 0
              saving_path:
              model_saving_strategy: best
              verbose: true
              optimizer: adam
              optimizer_weight_decay: 0.01
              optimizer_betas:
              - 0.9
              - 0.999
              optimizer_eps: 1e-08
              learning_rate:
        paths.metrics_dir: reports/metrics
        paths.plots_dir: reports/plots/model_eval
        paths.reports_dir: reports/model_eval
        tracking:
          enabled: true
          repo_owner: PetelinekBenjamin
          repo_name: air-quality-missing-data-imputation
          experiment_name: air-quality-imputer
    outs:
    - path: reports/metrics/model_eval_metrics.json
      hash: md5
      md5: 7ba21fc0f64749efff067c97e4f60775
      size: 409
    - path: reports/metrics/summary_by_feature_for_dvc_plots.csv
      hash: md5
      md5: 6a58aaaf7b545817969c93c9f2fafbb4
      size: 1288
    - path: reports/model_eval
      hash: md5
      md5: d7740a58f2f3438f3a4f75029ebb84e3.dir
      size: 4423
      nfiles: 10
    - path: reports/plots/model_eval
      hash: md5
      md5: eccbad813ce9b464192c4ecb5877f5f5.dir
      size: 94126
      nfiles: 2
